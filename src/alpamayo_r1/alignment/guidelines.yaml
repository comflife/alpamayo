# Off-Road Trajectory Consistency Guidelines for Alpamayo-R1 Fine-tuning
# Purpose: FIRST identify drivable paths, THEN avoid hazards within those paths
# Key objective: Follow established tracks/trails, stay on drivable terrain, avoid obstacles

rules:
  # ============================================================================
  # 0. DRIVABLE PATH IDENTIFICATION (HIGHEST PRIORITY)
  # ============================================================================
  - id: drivable_path_identification
    category: path_identification
    description: "FIRST identify where the vehicle CAN drive, then choose the safest route among those options."
    priority: critical
    enabled: true
    details: |
      **STEP 1: IDENTIFY DRIVABLE TERRAIN**
      Before evaluating hazards, identify what IS drivable:
      - Tire tracks / wheel ruts (darker, compressed soil showing prior vehicle passage)
      - Worn grass paths (grass is shorter, flattened, or absent from repeated use)
      - Cleared trails (visible path boundaries, less dense vegetation)
      - Compacted dirt/gravel surfaces
      - Roads or trail surfaces (visually distinct from surrounding terrain)
      
      **STEP 2: IDENTIFY NON-DRIVABLE AREAS**
      These are ABSOLUTE no-go zones:
      - Trees, bushes, dense vegetation (green foliage blocking path)
      - Large rocks, boulders, obstacles
      - Steep embankments, cliffs, drops
      - Deep water/rivers (not puddles, but significant water bodies)
      - Fences, barriers, structures
      
      **STEP 3: CHOOSE BEST PATH**
      Among drivable options, prefer:
      1. Established tire tracks (most commonly used = safest)
      2. Clearer/wider paths
      3. Firmer ground (less mud/sand)
      
      CORRECT IF model:
      - Plans trajectory INTO trees, dense vegetation, or obstacles
      - Ignores visible tire tracks and goes off-trail
      - Heads toward non-drivable terrain
      
      SHOULD DO:
      - Follow existing tire tracks when visible
      - Stay on established paths/trails
      - Recognize and follow the "main route" based on visual wear patterns

  # ============================================================================
  # 1. DRIVABLE CORRIDOR SELECTION (WIDEST + FIRMEST)
  # ============================================================================
  - id: drivable_corridor_selection
    category: corridor_planning
    description: "Choose the widest, firmest, continuous drivable corridor and commit to it."
    priority: critical
    enabled: true
    details: |
      Off-road often provides multiple imperfect tracks. The correct behavior is to choose
      the best corridor (firm + wide + continuous) and avoid frequent switching.

      EVALUATE FOR:
      - A visible open corridor (often grassy/less muddy) adjacent to puddles/ruts
      - Track continuity ahead (does it remain usable for several meters?)
      - Width margins from puddles, ruts, and vegetation

      CORRECT IF model:
      - Centers between ruts even when the center is muddy/wet
      - Switches left/right corridor without a strong new hazard
      - Chooses a narrower corridor when a wider firm corridor exists

      SHOULD DO:
      - Prefer firm ground (lighter, textured, less reflective) over dark reflective mud/water
      - Prefer a corridor that stays usable over the lookahead horizon (not just locally)
      - Keep a safety margin from puddle edges (avoid sliding into it)

  # ============================================================================
  # 2. PUDDLE & WATER AVOIDANCE (WHEEL-TRACK SAFETY)
  # ============================================================================
  - id: puddle_avoidance
    category: wheel_safety
    description: "Do not route wheels through puddles or reflective water unless no alternative exists."
    priority: critical
    enabled: true
    details: |
      Water depth is uncertain; puddles may hide holes, rocks, or deep mud. The safest default is avoidance.

      EVALUATE FOR:
      - Reflective surfaces, standing water, pooled areas, wet sheen
      - Puddle edges where traction changes abruptly
      - Alternate dry/firm shoulder or higher ground

      CORRECT IF model:
      - Keeps trajectory through puddle center
      - Places the trajectory too close to puddle edge (high slip-in risk)
      - Assumes puddles are shallow without evidence

      SHOULD DO:
      - Offset trajectory to keep both wheel tracks on dry/firm ground
      - Maintain extra lateral margin near puddle edges
      - If unavoidable, slow to crawl and keep steering minimal (straight, stable crossing)

  # ============================================================================
  # 3. RUT MANAGEMENT (AVOID DEEPEST GROOVES)
  # ============================================================================
  - id: rut_management
    category: wheel_safety
    description: "Avoid the deepest ruts; prefer shallow tracks or higher ground to reduce getting stuck and loss of control."
    priority: high
    enabled: true
    details: |
      Deep ruts can trap wheels and force unwanted steering. Prefer shallow ruts or the firm shoulder.

      EVALUATE FOR:
      - Parallel grooves (ruts) with darker mud inside
      - Raised center ridge or firmer side berms
      - Unevenness suggesting deep grooves

      CORRECT IF model:
      - Drives into the darkest rut channel
      - Follows rut centerline when a higher/shallower path exists
      - Makes sharp lateral moves across ruts at speed

      SHOULD DO:
      - Prefer a line that keeps wheels on higher, firmer ground (often beside ruts)
      - Cross ruts only when necessary, at low speed, with near-perpendicular approach
      - Keep curvature low to avoid wheel trapping

  # ============================================================================
  # 4. CONSISTENCY & HYSTERESIS (NO OSCILLATION)
  # ============================================================================
  - id: corridor_commitment_hysteresis
    category: consistency
    description: "Once a safe corridor is chosen, keep it unless a clear new hazard forces a change."
    priority: critical
    enabled: true
    details: |
      Off-road requires stable decisions. Frequent left-right changes are unsafe and reduce model reliability.

      EVALUATE FOR:
      - Repeated frames of similar terrain (same puddle/rut layout)
      - Small lateral biases that flip direction without new evidence

      CORRECT IF model:
      - Alternates between left and right corridor across similar samples
      - Overreacts to minor texture changes with major lateral corrections
      - Fails to preserve the previously safe corridor

      SHOULD DO:
      - Use a "commitment bias": stay in the selected corridor if it remains safe
      - Only switch corridors when current corridor becomes clearly worse (blocked, deep mud, narrowing)
      - Prefer smooth micro-adjustments over large lateral jumps

  # ============================================================================
  # 5. NEAR-FIELD TERRAIN PRIORITY (IMMEDIATE TRAJECTORY CORRECTION)
  # ============================================================================
  - id: near_field_terrain_priority
    category: near_field
    description: "Prioritize immediate roughness/obstacles over distant or hypothetical risks; adjust speed/curvature/wheel placement accordingly."
    priority: critical
    enabled: true
    details: |
      Off-road failures are driven by immediate terrain: bumps, rocks, holes, mud patches, puddle edges.

      EVALUATE FOR:
      - Visible bumps/rocks/holes/ruts within short distance
      - Uneven terrain that requires immediate wheel placement changes

      CORRECT IF model:
      - Produces a smooth-looking path that ignores visible roughness
      - Keeps speed/curvature similar to on-road behavior
      - Avoids "necessary" small detours around immediate hazards

      SHOULD DO:
      - Reduce speed first, then adjust path
      - Allow small detours and micro-corrections to protect wheels and undercarriage
      - Keep the path controllable and recoverable

  # ============================================================================
  # 6. SMOOTH CONTROL ON LOW FRICTION (LIMIT CURVATURE/JERK)
  # ============================================================================
  - id: low_friction_smoothness
    category: control_limits
    description: "On muddy/wet ground, avoid sharp steering and abrupt braking; keep curvature and jerk low."
    priority: high
    enabled: true
    details: |
      Wet mud and mixed surfaces amplify slip. Stability beats aggressiveness.

      EVALUATE FOR:
      - Wet or muddy surfaces
      - Surface transitions (dry -> wet, grass -> mud)
      - Narrow corridor near puddles/ruts

      CORRECT IF model:
      - Plans sharp turns near puddle edges
      - Uses aggressive braking/acceleration on muddy ground
      - Makes sudden lateral changes

      SHOULD DO:
      - Prefer gentle curvature and early mild deceleration
      - Maintain steady throttle on low traction
      - Keep a larger stopping margin

  # ============================================================================
  # 7. SAFE CLEARANCE (EDGE / VEGETATION / DROP-OFF)
  # ============================================================================
  - id: safe_clearance_margins
    category: clearance
    description: "Maintain clearance from trail edges, vegetation, and soft shoulders while avoiding puddles/ruts."
    priority: medium
    enabled: true
    details: |
      Avoid trading puddle avoidance for edge hazards (soft shoulder, hidden holes, vegetation snag).

      EVALUATE FOR:
      - Trail boundary softness, grass shoulder uncertainty
      - Bushes/branches close to path
      - Narrowing corridors

      CORRECT IF model:
      - Hugs edges excessively with no margin
      - Cuts into uncertain shoulder that may collapse or hide holes

      SHOULD DO:
      - Keep a practical margin from edges while remaining wheel-safe
      - Prefer the most predictable surface even if slightly longer

  # ============================================================================
  # 8. IF FORCED TO CROSS WATER/MUD (FAIL-SAFE CROSSING)
  # ============================================================================
  - id: unavoidable_crossing_failsafe
    category: failsafe
    description: "If water/mud is unavoidable, cross slowly, straight, and with minimal steering/braking."
    priority: high
    enabled: true
    details: |
      Sometimes no dry corridor exists. In that case, the goal is to minimize slip and avoid stopping mid-section.

      EVALUATE FOR:
      - No visible alternative around puddle/mud
      - Narrow trail fully blocked by water

      CORRECT IF model:
      - Enters water/mud at speed
      - Turns sharply while in water/mud
      - Brakes hard inside the puddle/mud

      SHOULD DO:
      - Slow BEFORE entry, then maintain steady low speed
      - Keep steering near-straight through the section
      - Exit to firmer ground before attempting any major maneuver

# ============================================================================
# GLOBAL EVALUATION GUIDELINES
# ============================================================================
# When evaluating Alpamayo outputs:
#
# 1. IDENTIFY immediate near-field terrain hazards (puddles, deep mud, ruts, roughness)
# 2. CHECK if the model selects a firm, wide, continuous corridor (drivable corridor)
# 3. VERIFY wheel-safe placement: avoid puddles/deep ruts; keep margin from puddle edges
# 4. ENFORCE consistency: once a corridor is safe, avoid left-right oscillation
# 5. MARK as VIOLATED only if a specific rule above is clearly broken
# 6. If terrain is ambiguous, prefer conservative, recoverable trajectories (slow + smooth)
#
# REMEMBER:
# - "Centered" is not the goal; "wheel-safe and consistent" is the goal.
# - Small micro-adjustments are good; frequent corridor switching is bad.
# - Avoid puddles by default; only cross when clearly unavoidable.
